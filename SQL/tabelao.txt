-------------------------------------------------------------------------------
--- UNIDADE DE ANALISE: PROPOSTAS (CONVENIOS E REPASSES SÃO OS PRINCIPAIS RESULTADOS)
-------------------------------------------------------------------------------
DROP MATERIALIZED VIEW SICONV.tabelao;
CREATE MATERIALIZED VIEW SICONV.tabelao AS
select
    -- Identificadores
    siconv.proposta.nr_proposta                 as id_proposta,
    siconv.convenio.nr_convenio                 as id_convenio,
    SICONV.emenda.COD_PROGRAMA_EMENDA           as id_programa,
    SICONV.emenda.NR_EMENDA                     as id_emenda,

    --siconv.proposta.objeto_proposta             as descricao_proposta,

    -- Quando?
    siconv.proposta.dia_proposta                            as dia_proposta,
    substring(siconv.proposta.dia_proposta from 7)::integer as ano_proposta,
    left(substring(dia_proposta from 4 ),2)                 as mes_proposta,

    siconv.proposta.dia_inic_vigencia_proposta  as dia_inicio_vigencia_proposta,
    siconv.proposta.dia_fim_vigencia_proposta   as dia_fim_vigencia_proposta,
    siconv.convenio.dia_assin_conv              as dia_assinatura_convenio,
    siconv.convenio.dia_publ_conv               as dia_publicacao_convenio,
    siconv.convenio.dia_inic_vigenc_conv        as dia_inicio_vigencia_convenio,
    siconv.convenio.dia_fim_vigenc_conv         as dia_final_vigencia_convenio,
    siconv.convenio.dia_limite_prest_contas     as dia_limite_prestacao_contas,

    -- Como anda?

    -- Grupo situacao_proposta
    CASE WHEN proposta.sit_proposta = 'Proposta/Plano de Trabalho Aprovados' THEN 'Aprovada'
        WHEN proposta.sit_proposta ~ 'Rejeita' or proposta.sit_proposta ~ 'Eliminada'    THEN 'Rejeitada'
        ELSE 'Em processo' END AS situacao_proposta_grupo,

    siconv.proposta.sit_proposta         as situacao_proposta,
    siconv.proposta.modalidade           as modalidade,
    siconv.convenio.situacao_contratacao as situacao_contratacao,
    siconv.convenio.instrumento_ativo    as convenio_ativo,             -- Tirei pois eh soh um agrupamento de situação convenio
    siconv.convenio.ind_assinado         as situacao_assinatura,
    siconv.convenio.sit_convenio         as situacao_convenio,
    siconv.convenio.subsituacao_conv     as subsituacao_convenio,
    siconv.convenio.situacao_publicacao  as situacao_publicacao,
    siconv.convenio.ind_opera_obtv       as indicador_obtv,             -- Ordem Bancária de Transferências Voluntárias
    siconv.convenio.qtd_ta               as quantidade_termos_aditivos,
    siconv.convenio.qtd_prorroga         as quantidade_prorrogacoes,

    -- Quanto custa?
    CAST ( case when siconv.proposta.vl_global_prop=''            then NULL ELSE replace(siconv.proposta.vl_global_prop, ',','.')           end AS numeric) as valor_total,
    CAST ( case when siconv.proposta.vl_repasse_prop=''           then NULL ELSE replace(siconv.proposta.vl_repasse_prop, ',','.')          end AS numeric) as valor_repasse_uniao,
    CAST ( case when siconv.proposta.vl_contrapartida_prop=''     then NULL ELSE replace(siconv.proposta.vl_contrapartida_prop, ',','.')    end AS numeric) as valor_contrapartida,
    CAST ( case when siconv.convenio.VL_EMPENHADO_CONV=''         then NULL ELSE replace(siconv.convenio.VL_EMPENHADO_CONV, ',','.')        end AS numeric) as valor_empenhado_conv,
    CAST ( case when siconv.convenio.VL_DESEMBOLSADO_CONV=''      then NULL ELSE replace(siconv.convenio.VL_DESEMBOLSADO_CONV, ',','.')     end AS numeric) as valor_desembolsado_conv,
    CAST ( case when siconv.convenio.VL_SALDO_REMAN_TESOURO=''    then NULL ELSE replace(siconv.convenio.VL_SALDO_REMAN_TESOURO, ',','.')   end AS numeric) as saldo_remanescente_tesouro_conv,
    CAST ( case when siconv.convenio.VL_SALDO_REMAN_CONVENENTE='' then NULL ELSE replace(siconv.convenio.VL_SALDO_REMAN_CONVENENTE, ',','.')end AS numeric) as saldo_remanescente_convenente_conv,
    CAST ( case when siconv.convenio.VL_RENDIMENTO_APLICACAO=''   then NULL ELSE replace(siconv.convenio.VL_RENDIMENTO_APLICACAO, ',','.')  end AS numeric) as valor_rendimento_aplicacao_conv,
    CAST ( case when siconv.convenio.VL_INGRESSO_CONTRAPARTIDA='' then NULL ELSE replace(siconv.convenio.VL_INGRESSO_CONTRAPARTIDA, ',','.')end AS numeric) as valor_ingresso_contrapartida_conv,
    CAST ( case when siconv.convenio.VL_SALDO_CONTA=''            then NULL ELSE replace(siconv.convenio.VL_SALDO_CONTA, ',','.')           end AS numeric) as valor_saldo_conv,
    
    -- Via emenda?
    SICONV.emenda.VALOR_REPASSE_EMENDA          as valor_repasse_emenda,
    siconv.emenda.QUALIF_PROPONENTE             as dummy_emenda_parlamentar,
    SICONV.emenda.NOME_PARLAMENTAR              as parlamentar,
    SICONV.emenda.BENEFICIARIO_EMENDA           as beneficiario_emenda,
    SICONV.emenda.IND_IMPOSITIVO                as emenda_impositiva,
    SICONV.emenda.tipo_parlamentar              as tipo_parlamentar,

    -- Lado não federal do convenio?
    case when siconv.proposta.uf_proponente in ('AC','AM','AP','PA','RO','RR','TO')           then 'Norte'
         when siconv.proposta.uf_proponente in ('AL','BA','CE','MA','PB','PE','PI','RN','SE') then 'Nordeste'
         when siconv.proposta.uf_proponente in ('DF','GO','MS','MT')                          then 'Centro-Oeste'
         when siconv.proposta.uf_proponente in ('ES','MG','RJ','SP')                          then 'Sudeste'
         when siconv.proposta.uf_proponente in ('PR','RS','SC')                               then 'Sul'
         else NULL end as regiao_proponente,

    siconv.proposta.uf_proponente               as uf_proponente,
    siconv.proposta.munic_proponente            as municipio_proponente,
    siconv.proposta.nm_proponente               as nm_proponente,

    -- Lado federal do convenio
    siconv.proposta.desc_orgao_sup              as orgao_sup,
    siconv.proposta.desc_orgao                  as orgao,
    siconv.proposta.natureza_juridica           as natureza_juridica

FROM siconv.proposta
full join siconv.convenio on proposta.id_proposta = convenio.id_proposta
full join siconv.emenda   on proposta.id_proposta = emenda.id_proposta

--\copy (select id_proposta,id_convenio,id_programa,id_emenda,dia_proposta,dia_inicio_vigencia_proposta,dia_fim_vigencia_proposta,dia_assinatura_convenio,dia_publicacao_convenio,dia_inicio_vigencia_convenio,dia_final_vigencia_convenio,dia_limite_prestacao_contas,modalidade,situacao_proposta,situacao_contratacao,convenio_ativo,situacao_convenio,subsituacao_convenio,situacao_publicacao,indicador_obtv,quantidade_termos_aditivos,quantidade_prorrogacoes,valor_total,valor_repasse_uniao,valor_contrapartida,valor_empenhado_conv,valor_desembolsado_conv,saldo_remanescente_tesouro_conv,saldo_remanescente_convenente_conv,valor_rendimento_aplicacao_conv,valor_ingresso_contrapartida_conv,valor_saldo_conv,valor_repasse_emenda,dummy_emenda_parlamentar,parlamentar,beneficiario_emenda,emenda_impositiva,tipo_parlamentar,uf_proponente,municipio_proponente,nm_proponente,orgao_sup,orgao,natureza_juridica from SICONV.tabelao) to 'C:/Users/pedro.palotti/Documents/SICONV/output.txt'
